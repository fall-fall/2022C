# 问题一求解：代码细节与建模全流程文档

**主题：** 对C题问题一的全流程技术实现进行回顾与总结，旨在提供详尽素材。

---

### 1. 数据加载与准备 (Data Loading and Preparation)

* **1.1 数据源与起点**

  * **输入文件**：我们所有分析工作的起点，是基于您提供的预处理脚本最终生成的单一、高质量数据文件——`处理后的数据.xlsx`中的 `已分类清洗后数据`工作表。
  * **数据状态**：该数据已经完成了初步的缺失值填充和有效性筛选（成分总和在85%~105%之间），为后续分析的可靠性奠定了坚实基础。
* **1.2 关键变量的定义**

  * **处理方式**：在加载数据后，我们面临的首要任务是精确地定义出哪些列属于“化学成分”。为确保过程的稳健性和可重复性，我们摒弃了依赖“黑名单”排除非数值列的简单方法。
  * **核心技术**：我们采用了更严谨的**数据类型筛选法**。首先，使用Pandas的 `select_dtypes(include=np.number)`方法，自动识别出数据表中所有数值类型的列。然后，从这些数值列中，我们再排除了已知的、非化学成分的ID列（如 `文物编号`）和中间计算列（`成分总和`），最终得到一个纯净的 `chemical_columns`列表。
  * **理由**：这一步骤至关重要，它从根本上杜绝了后续数值计算中因数据类型不匹配（`UFuncTypeError`）而导致的程序中断，是代码稳健性的第一道防线。

### 2. 关系分析：风化与样本属性的关联性检验

* **2.1 核心目标**

  * 根据题目要求，我们需要从统计学层面，判断“表面风化”这一状态变量，是否与玻璃的“类型”、“纹饰”和“颜色”这三个物理属性存在显著的关联。
* **2.2 算法选择与原理**

  * **算法**：针对两个分类变量的关联性分析，我们选用了统计学中的经典方法——**卡方检验 (Chi-squared Test)**。
  * **原理与理由**：卡方检验通过比较**实际观测频数**与**理论期望频数**（即假设变量间相互独立时的频数）的差异，来判断变量间是否存在关联。其P值能够提供一个明确的、量化的判断依据（我们以P < 0.05为显著标准）。
  * **输出成果**：检验结果被清晰地输出，并保存至 `Result/问题一_关系分析统计检验结果.csv`文件中。
* **2.3 可视化策略**

  * **目的**：为了将抽象的统计结论转化为直观的视觉证据，我们为关系分析设计了专门的可视化图表。
  * **图表设计**：我们生成了一张包含多个子图的综合图表(`Result/问题一_关系分析可视化.png`)，针对不同属性采用不同但最合适的图表类型：
    * **风化 vs 类型**: 采用**堆积百分比条形图**，直观展示不同类型玻璃中风化样本的构成比例。
    * **风化 vs 纹饰/颜色**: 采用**分组计数条形图**，清晰对比在不同纹饰或颜色下，风化与无风化样本的绝对数量。

### 3. 统计规律探索：风化对化学成分的影响

* **3.1 核心目标**

  * 定量并可视化地揭示风化过程对高钾和铅钡玻璃中，各种化学成分含量的具体影响规律。

  **3.2 分组分析：四类样本的分布特征**

  * **核心目标**: 深入探究在“类型”和“风化”共同作用下的四种样本组，其内部的数据分布形态，以补充箱线图仅能提供部分统计信息的不足。
  * **方法论**:
    * **（1）描述性统计**: 我们首先通过 `.groupby().describe()`方法，为四个分组计算了包括均值、标准差、中位数、四分位数在内的**全套描述性统计量**。这为定量分析提供了详实的数据基础。
    * **（2）分布可视化**: 为直观展示各组数据的分布形状（如是否正态、偏态等），我们为关键化学成分绘制了**分面直方图，并叠加了核密度估计曲线(KDE)**。
  * **理由**: 这套组合拳让我们既能从数值上精确把握各组数据的统计特性，又能从图形上直观洞察其分布形态，构成了对分组数据最全面的认知。
  * **输出成果**: `Result/问题一_分组描述性统计.xlsx` 和一系列以 `Result/问题一_分布图_{化学成分名}.png` 命名的图片文件。
* **3.3  箱线图分析**

  * **图表选择**: 我们选择了**分面箱线图 (Faceted Box Plot)** 作为此任务的核心可视化工具。
  * **理由**: 相比仅展示均值，箱线图能提供更丰富的数据分布信息（中位数、四分位距、离散程度和异常点），可以更全面地洞察风化对化学成分分布形态的整体影响。
  * **实现细节**: 通过 `seaborn.catplot`，我们按“类型”对图表进行分面，在每个子图中再按“表面风化”进行分组对比。特别地，我们设置了 `sharey=False`，因为两类玻璃的化学成分含量范围差异巨大，独立的Y轴能确保每个子图的内部细节都能清晰呈现。
  * **输出成果**：该分析图表被保存为 `Result/问题一_化学成分统计规律.png`。

### 4. 模型预测：风化前化学成分的恢复

* **4.1 建模思想与理论依据**

  * **核心挑战**: 本任务面临的巨大挑战是成对训练样本的极度稀疏，这使得标准监督学习模型存在灾难性的过拟合风险，基本不可行。
  * **方案选择**: 为此，我们设计了一个**基于地球化学风化动力学原理的“风化系数”预测模型**。该模型的优势在于，它并非纯粹的数据驱动“黑箱”，而是建立在对风化过程的科学理解之上，使其在小样本条件下具有极强的科学合理性。
  * **理论基础 (跨学科)**: 模型的思想来源于**地球化学领域的质量平衡分析 (Mass Balance Analysis)**。我们假设玻璃中某种化学成分的流失（或富集）量，与其风化前的原始浓度成**正比**关系。
  * **参考文献支撑**:
    > Grant, J. A. (1986). The isocon diagram—a simple solution to gresens' equation for metasomatic alteration. *Economic Geology*, 81(8), 1976-1982.
    >
  * **关联性说明**: 该文献提出的方法是地球化学领域的经典工具，其核心就是通过计算化学成分在变化前后的**浓度比值**来确定元素的亏损或富集。我们计算“风化系数k”的公式正是这一思想的直接代数体现。
* **4.2 算法原理与数学公式**

  1. **“风化系数(k)”的计算**：
     $$
     k_{t,j} = 1 - \frac{\bar{C}_{t,j,\text{weathered}}}{\bar{C}_{t,j,\text{unweathered}}}
     $$
  2. **初步预测公式**：
     $$
     C'_{\text{unweathered}, j} = \frac{C_{\text{weathered}, j}}{1 - k_{t,j}}
     $$
  3. **边界条件校正**：对初步预测值 `C'`的总和 `S'`进行判断，并进行**条件归一化**，确保最终总和落在 `[85, 105]`的有效区间内。
* **4.3 代码实现中的稳健性处理**
  在将理论模型转化为实际代码的过程中，我们通过**使用 `np.divide`并设置 `where`条件**和**在循环内部强制进行数值类型净化**，成功解决了 `ZeroDivisionError`和 `UFuncTypeError`两类潜在的运行时错误，确保了代码的绝对稳健。
* **4.4 输出成果**

  * 模型的最终预测结果，以原始含量和预测含量并列对比的形式，被完整地保存至 `Result/问题一_预测结果(融合模型法).xlsx`文件中。
